<!DOCTYPE html>
<!-- 
    This declares the document type as HTML5. 
    HTML5 is the latest version of HTML and provides modern features.
-->
<html lang="en">
<!-- 
    The <html> element is the root element of the page.
    lang="en" tells browsers and screen readers this page is in English.
-->
<head>
    <!-- 
        The <head> section contains metadata about the page that doesn't appear in the browser window.
        This information is used by browsers, search engines, and other tools.
    -->
    
    <meta charset="UTF-8">
    <!-- 
        This sets the character encoding to UTF-8, which supports all Unicode characters.
        This ensures special characters like emojis (üïµÔ∏è) display correctly.
    -->
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 
        This makes the page responsive (mobile-friendly).
        width=device-width: Makes the page width match the device's screen width
        initial-scale=1.0: Sets the initial zoom level to 100%
    -->
    
    <title>SpyGame</title>
    <!-- 
        The text that appears in the browser tab/window title.
        Also used by search engines as the clickable headline in search results.
    -->
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- 
        This links to our CSS file that contains all the styling.
        {{ url_for('static', filename='style.css') }} is Flask template syntax that
        generates the correct URL path to our CSS file.
    -->
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <!-- 
        Google Fonts link for thematic "Spy/Hacker" typography.
        'Share Tech Mono' for headings and display elements.
        'JetBrains Mono' for hints list items.
    -->
</head>
<body>
    <!-- 
        The <body> element contains all the visible content of the page.
        Everything users see and interact with goes inside here.
    -->

    <div class="container">
        <!-- 
            This div wraps all our content and centers it on the page.
            The "container" class is defined in our CSS file and sets max-width and centering.
        -->
        
        <!-- Header row with title and user status sections -->
        <div class="header-row">
            <header>
                <!-- 
                    The <header> element represents the top section of our page.
                    It typically contains headings, logos, and introductory content.
                -->
                <h1>üïµÔ∏è SpyGame</h1>
                <p>Guess the Wikipedia person based on hints!</p>
            </header>

            <div id="user-status" class="user-status-section">
                <!-- User authentication status area -->
                <span id="user-display">GUEST</span>
                <div class="auth-buttons">
                    <button id="login-btn" class="btn btn-tiny">Login</button>
                    <button id="register-btn" class="btn btn-tiny">Register</button>
                    <button id="logout-btn" class="btn btn-tiny" style="display: none;">Logout</button>
                    <a href="/stats" id="stats-link" class="btn btn-tiny btn-stats" style="display: none;">Stats</a>
                </div>
            </div>
        </div>

        <main>
            <!-- 
                The <main> element contains the primary content of the page.
                It represents the main functionality - in this case, the game itself.
            -->
            
            <div id="game-area">
                <!-- 
                    This div contains all the game-related elements.
                    The id="game-area" allows us to reference this specific element in CSS and JavaScript.
                -->

                <div id="hints-section" class="hints-section" style="display: none;">
                    <!-- 
                        This section displays the hints that the player has requested.
                        id="hints-section": Unique identifier for JavaScript to show/hide this section
                        class="hints-section": CSS class for styling the hints container
                        style="display: none;": Initially hidden until a game starts
                    -->
                    
                    <h3>Hints: <span id="status-message" class="status-message"></span></h3>
                    <!-- 
                        <h3> is a third-level heading (smaller than h1 and h2).
                        It labels this section so users know what the content below represents.
                    -->
                    
                    <div class="hints-scroll-container">
                        <!-- 
                            Scrollable container for hints list.
                            Maximum height allows viewing 5-6 hints with scroll for more.
                        -->
                        <ul id="hints-list"></ul>
                        <!-- 
                            <ul> creates an unordered (bulleted) list.
                            id="hints-list": JavaScript will add hint items to this list
                            Initially empty - hints are added dynamically via JavaScript
                        -->
                    </div>
                    
                    <p id="hints-remaining"></p>
                    <!-- 
                        This paragraph will show how many hints are left.
                        id="hints-remaining": JavaScript updates this text as hints are used
                    -->
                </div>

                <div class="game-controls">
                    <!-- 
                        This div contains all the main action buttons for the game.
                        The class="game-controls" applies CSS styling to center and space the buttons.
                        Placed below hints section but above guess section for fixed position.
                    -->
                    
                    <button id="start-game-btn" class="btn btn-primary">Start New Game</button>
                    <!-- 
                        HTML button element that users click to start a new game.
                        id="start-game-btn": Unique identifier for JavaScript to attach click events
                        class="btn btn-primary": CSS classes for button styling (btn = general button, btn-primary = primary action styling)
                    -->
                    
                    <button id="get-hint-btn" class="btn btn-secondary" disabled>Get Hint</button>
                    <!-- 
                        Button to request hints during gameplay.
                        disabled: HTML attribute that makes the button unclickable until a game starts
                        class="btn btn-secondary": Secondary button styling (less prominent than primary)
                    -->
                    
                    <button id="reveal-answer-btn" class="btn btn-danger" disabled>Reveal Answer</button>
                    <!-- 
                        Button to give up and reveal the answer.
                        class="btn btn-danger": Danger styling (red) to indicate this ends the game
                    -->
                </div>

                <div id="guess-section" class="guess-section" style="display: none;">
                    <!-- 
                        This section contains the input field and button for making guesses.
                        Initially hidden until a game starts (style="display: none;")
                    -->
                    
                    <h3>Make Your Guess:</h3>
                    <!-- Heading that tells the user what this section is for -->
                    
                    <div class="guess-input">
                        <!-- 
                            Container div that uses CSS flexbox to arrange the input and button side by side.
                            class="guess-input": CSS class that applies flexbox layout
                        -->
                        
                        <input type="text" id="guess-input" placeholder="Enter your guess..." maxlength="100">
                        <!-- 
                            Text input field where users type their guesses.
                            type="text": Specifies this is a text input field
                            id="guess-input": JavaScript uses this to get the typed value
                            placeholder="Enter your guess...": Gray text shown when field is empty
                            maxlength="100": Limits input to 100 characters
                        -->
                        
                        <button id="submit-guess-btn" class="btn btn-primary">Submit Guess</button>
                        <!-- 
                            Button to submit the guess.
                            When clicked, JavaScript gets the value from the input field above
                        -->
                    </div>
                </div>

                <div id="result-section" class="result-section"></div>
                <!-- 
                    This div will contain game results and outcome messages.
                    Initially empty - JavaScript adds content here when games end
                -->
            </div>
        </main>
        <!-- End of main content area -->
    </div>
    <!-- End of container div -->

    <!-- Info button moved to bottom of page -->
    <div class="info-button-bottom">
        <button id="info-btn" class="btn btn-info" title="About this project">‚ùì</button>
    </div>

    <!-- Loading Indicator Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="radar-spinner">
            <div class="radar-pulse"></div>
        </div>
    </div>

    <!-- Authentication Modals -->
    <div id="login-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Login</h3>
                <span class="close" id="login-close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="login-error" class="modal-error" style="display: none;"></div>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-username">Username:</label>
                        <input type="text" id="login-username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password:</label>
                        <input type="password" id="login-password" name="password" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Login</button>
                        <button type="button" class="btn btn-secondary" id="cancel-login">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="register-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Register</h3>
                <span class="close" id="register-close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="register-error" class="modal-error" style="display: none;"></div>
                <form id="register-form">
                    <div class="form-group">
                        <label for="register-username">Username:</label>
                        <input type="text" id="register-username" name="username" required minlength="3">
                        <small>At least 3 characters</small>
                    </div>
                    <div class="form-group">
                        <label for="register-password">Password:</label>
                        <input type="password" id="register-password" name="password" required minlength="6">
                        <small>At least 6 characters</small>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Register</button>
                        <button type="button" class="btn btn-secondary" id="cancel-register">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Knowledge Profile Survey Modal -->
    <div id="knowledge-profile-modal" class="modal survey-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Cuestionario de Conocimientos (Opcional)</h3>
                <span class="close" id="knowledge-profile-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="survey-intro">
                    <p><strong>¬°Gracias por registrarte!</strong></p>
                    <p>Para nuestro proyecto de investigaci√≥n, nos gustar√≠a conocer tu nivel de conocimientos en diferentes √°reas.</p>
                    <p>Este cuestionario es <strong>totalmente opcional</strong> y an√≥nimo. Puedes saltar esta secci√≥n si lo prefieres.</p>
                    <p>Por favor, eval√∫a tu nivel del 1 al 5 en cada √°rea:</p>
                </div>
                
                <!-- Skip button at the top -->
                <div class="form-actions" style="margin-bottom: 20px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" id="skip-survey">Saltar Cuestionario</button>
                </div>
                
                <form id="knowledge-profile-form">
                    <!-- Question 1: Cultura General -->
                    <div class="survey-question">
                        <label class="question-label">1. Cultura General</label>
                        <span class="question-description">Tu nivel general de conocimientos sobre hechos, personas y eventos conocidos por la sociedad.</span>
                        <div class="rating-scale">
                            <div class="rating-option">
                                <input type="radio" id="cg-1" name="cultura_general" value="1" required>
                                <label for="cg-1">1</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="cg-2" name="cultura_general" value="2">
                                <label for="cg-2">2</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="cg-3" name="cultura_general" value="3">
                                <label for="cg-3">3</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="cg-4" name="cultura_general" value="4">
                                <label for="cg-4">4</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="cg-5" name="cultura_general" value="5">
                                <label for="cg-5">5</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Ni idea</span>
                            <span>Muy versado</span>
                        </div>
                    </div>

                    <!-- Question 2: Geograf√≠a -->
                    <div class="survey-question">
                        <label class="question-label">2. Geograf√≠a</label>
                        <span class="question-description">Tu conocimiento sobre pa√≠ses, capitales, mapas y fen√≥menos geogr√°ficos.</span>
                        <div class="rating-scale">
                            <div class="rating-option">
                                <input type="radio" id="geo-1" name="geografia" value="1" required>
                                <label for="geo-1">1</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="geo-2" name="geografia" value="2">
                                <label for="geo-2">2</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="geo-3" name="geografia" value="3">
                                <label for="geo-3">3</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="geo-4" name="geografia" value="4">
                                <label for="geo-4">4</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="geo-5" name="geografia" value="5">
                                <label for="geo-5">5</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Ni idea</span>
                            <span>Muy versado</span>
                        </div>
                    </div>

                    <!-- Question 3: Actualidad y Noticias -->
                    <div class="survey-question">
                        <label class="question-label">3. Actualidad y Noticias</label>
                        <span class="question-description">Tu nivel de seguimiento y comprensi√≥n de las noticias y la pol√≠tica actual.</span>
                        <div class="rating-scale">
                            <div class="rating-option">
                                <input type="radio" id="act-1" name="actualidad_noticias" value="1" required>
                                <label for="act-1">1</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="act-2" name="actualidad_noticias" value="2">
                                <label for="act-2">2</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="act-3" name="actualidad_noticias" value="3">
                                <label for="act-3">3</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="act-4" name="actualidad_noticias" value="4">
                                <label for="act-4">4</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="act-5" name="actualidad_noticias" value="5">
                                <label for="act-5">5</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Ni idea</span>
                            <span>Muy versado</span>
                        </div>
                    </div>

                    <!-- Question 4: Cultura Popular -->
                    <div class="survey-question">
                        <label class="question-label">4. Cultura Popular</label>
                        <span class="question-description">Tu familiaridad con las tendencias actuales en m√∫sica, cine y series de televisi√≥n.</span>
                        <div class="rating-scale">
                            <div class="rating-option">
                                <input type="radio" id="cp-1" name="cultura_popular" value="1" required>
                                <label for="cp-1">1</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="cp-2" name="cultura_popular" value="2">
                                <label for="cp-2">2</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="cp-3" name="cultura_popular" value="3">
                                <label for="cp-3">3</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="cp-4" name="cultura_popular" value="4">
                                <label for="cp-4">4</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="cp-5" name="cultura_popular" value="5">
                                <label for="cp-5">5</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Ni idea</span>
                            <span>Muy versado</span>
                        </div>
                    </div>

                    <!-- Question 5: Tecnolog√≠a y Tendencias Digitales -->
                    <div class="survey-question">
                        <label class="question-label">5. Tecnolog√≠a y Tendencias Digitales</label>
                        <span class="question-description">Tu comprensi√≥n de c√≥mo funcionan las nuevas tecnolog√≠as, aplicaciones y redes sociales.</span>
                        <div class="rating-scale">
                            <div class="rating-option">
                                <input type="radio" id="tech-1" name="tecnologia_tendencias" value="1" required>
                                <label for="tech-1">1</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="tech-2" name="tecnologia_tendencias" value="2">
                                <label for="tech-2">2</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="tech-3" name="tecnologia_tendencias" value="3">
                                <label for="tech-3">3</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="tech-4" name="tecnologia_tendencias" value="4">
                                <label for="tech-4">4</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="tech-5" name="tecnologia_tendencias" value="5">
                                <label for="tech-5">5</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Ni idea</span>
                            <span>Muy versado</span>
                        </div>
                    </div>

                    <!-- Question 6: Uso de Wikipedia -->
                    <div class="survey-question">
                        <label class="question-label">6. Uso de Wikipedia</label>
                        <span class="question-description">Tu familiaridad con Wikipedia (no solo como lector, sino entendiendo c√≥mo se crea, se edita y se verifica su contenido).</span>
                        <div class="rating-scale">
                            <div class="rating-option">
                                <input type="radio" id="wiki-1" name="uso_wikipedia" value="1" required>
                                <label for="wiki-1">1</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="wiki-2" name="uso_wikipedia" value="2">
                                <label for="wiki-2">2</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="wiki-3" name="uso_wikipedia" value="3">
                                <label for="wiki-3">3</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="wiki-4" name="uso_wikipedia" value="4">
                                <label for="wiki-4">4</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="wiki-5" name="uso_wikipedia" value="5">
                                <label for="wiki-5">5</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Ni idea</span>
                            <span>Muy versado</span>
                        </div>
                    </div>

                    <!-- Question 7: Habilidad de B√∫squeda -->
                    <div class="survey-question">
                        <label class="question-label">7. Habilidad de B√∫squeda</label>
                        <span class="question-description">Tu habilidad para encontrar informaci√≥n fiable y de calidad en Internet (m√°s all√° de la primera b√∫squeda en Google).</span>
                        <div class="rating-scale">
                            <div class="rating-option">
                                <input type="radio" id="search-1" name="habilidad_busqueda" value="1" required>
                                <label for="search-1">1</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="search-2" name="habilidad_busqueda" value="2">
                                <label for="search-2">2</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="search-3" name="habilidad_busqueda" value="3">
                                <label for="search-3">3</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="search-4" name="habilidad_busqueda" value="4">
                                <label for="search-4">4</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="search-5" name="habilidad_busqueda" value="5">
                                <label for="search-5">5</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Ni idea</span>
                            <span>Muy versado</span>
                        </div>
                    </div>

                    <!-- Question 8: Pensamiento Cr√≠tico / Verificaci√≥n -->
                    <div class="survey-question">
                        <label class="question-label">8. Pensamiento Cr√≠tico / Verificaci√≥n</label>
                        <span class="question-description">Tu inter√©s o habilidad para verificar la informaci√≥n, detectar 'fake news' y analizar argumentos.</span>
                        <div class="rating-scale">
                            <div class="rating-option">
                                <input type="radio" id="crit-1" name="pensamiento_critico" value="1" required>
                                <label for="crit-1">1</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="crit-2" name="pensamiento_critico" value="2">
                                <label for="crit-2">2</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="crit-3" name="pensamiento_critico" value="3">
                                <label for="crit-3">3</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="crit-4" name="pensamiento_critico" value="4">
                                <label for="crit-4">4</label>
                            </div>
                            <div class="rating-option">
                                <input type="radio" id="crit-5" name="pensamiento_critico" value="5">
                                <label for="crit-5">5</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Ni idea</span>
                            <span>Muy versado</span>
                        </div>
                    </div>

                    <div class="form-actions" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">Enviar Respuestas</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        /* 
         * JavaScript Section: This adds interactivity to our HTML page
         * JavaScript runs in the user's browser and can:
         * - Respond to user interactions (clicks, typing, etc.)
         * - Modify the page content dynamically
         * - Communicate with our Flask server
         */
        
        // Game state variable to track if a game is currently active
        let gameActive = false;
        // Track if a request is in progress to prevent double submissions
        let isLoading = false;
        // Track hints remaining locally to prevent UI bugs when clicking fast
        let currentHintsRemaining = 0;

        /* 
         * DOM Element References: These variables store references to HTML elements
         * so we can easily interact with them throughout our JavaScript code.
         * document.getElementById() finds elements by their unique id attribute.
         */
        const startGameBtn = document.getElementById('start-game-btn');     // Start new game button
        const getHintBtn = document.getElementById('get-hint-btn');         // Get hint button
        const revealAnswerBtn = document.getElementById('reveal-answer-btn'); // Reveal answer button
        const hintsSection = document.getElementById('hints-section');       // Hints container
        const hintsList = document.getElementById('hints-list');           // List where hints appear
        const hintsRemaining = document.getElementById('hints-remaining');   // Hint counter text
        const guessSection = document.getElementById('guess-section');       // Guess input container
        const guessInput = document.getElementById('guess-input');          // Text input field
        const submitGuessBtn = document.getElementById('submit-guess-btn'); // Submit guess button
        const resultSection = document.getElementById('result-section');     // Results display area
        const infoBtn = document.getElementById('info-btn');               // Info button
        const loadingOverlay = document.getElementById('loading-overlay'); // Loading overlay
        const statusMessage = document.getElementById('status-message');   // Status message in hints header

        // Authentication-related DOM elements
        const userDisplay = document.getElementById('user-display');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const statsLink = document.getElementById('stats-link');
        const loginModal = document.getElementById('login-modal');
        const registerModal = document.getElementById('register-modal');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');

        // Knowledge Profile Survey elements
        const knowledgeProfileModal = document.getElementById('knowledge-profile-modal');
        const knowledgeProfileForm = document.getElementById('knowledge-profile-form');
        const skipSurveyBtn = document.getElementById('skip-survey');
        const knowledgeProfileClose = document.getElementById('knowledge-profile-close');

        // User authentication state - initialize from server session
        let currentUser = '{{ current_user }}' || 'guest';
        // Ensure we treat empty strings as guest
        if (!currentUser || currentUser.trim() === '') {
            currentUser = 'guest';
        }

        /* 
         * Event Listeners: These "listen" for user interactions and respond to them
         * addEventListener() tells the browser what function to call when an event happens
         */
        
        // Add event listeners with error handling
        try {
            // When the "Start New Game" button is clicked, call the startNewGame function
            if (startGameBtn) startGameBtn.addEventListener('click', startNewGame);
            
            // When the "Get Hint" button is clicked, call the getHint function
            if (getHintBtn) getHintBtn.addEventListener('click', getHint);
            
            // When the "Reveal Answer" button is clicked, call the revealAnswer function
            if (revealAnswerBtn) revealAnswerBtn.addEventListener('click', revealAnswer);
            
            // When the "Submit Guess" button is clicked, call the makeGuess function
            if (submitGuessBtn) submitGuessBtn.addEventListener('click', makeGuess);
            
            // Listen for key presses in the guess input field
            if (guessInput) {
                guessInput.addEventListener('keypress', function(e) {
                    // If the Enter key is pressed, submit the guess (same as clicking the button)
                    if (e.key === 'Enter') {
                        makeGuess();
                    }
                });
            }

            // When the info button is clicked, show project information
            if (infoBtn) infoBtn.addEventListener('click', showProjectInfo);

            // Authentication event listeners
            if (loginBtn) loginBtn.addEventListener('click', showLoginModal);
            if (registerBtn) registerBtn.addEventListener('click', showRegisterModal);
            if (logoutBtn) logoutBtn.addEventListener('click', logout);
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            if (registerForm) registerForm.addEventListener('submit', handleRegister);
            
            // Modal close events
            const loginClose = document.getElementById('login-close');
            const registerClose = document.getElementById('register-close');
            const cancelLogin = document.getElementById('cancel-login');
            const cancelRegister = document.getElementById('cancel-register');
            
            if (loginClose) loginClose.addEventListener('click', hideLoginModal);
            if (registerClose) registerClose.addEventListener('click', hideRegisterModal);
            if (cancelLogin) cancelLogin.addEventListener('click', hideLoginModal);
            if (cancelRegister) cancelRegister.addEventListener('click', hideRegisterModal);
            
            // Knowledge Profile Survey event listeners
            if (knowledgeProfileForm) knowledgeProfileForm.addEventListener('submit', handleKnowledgeProfileSubmit);
            if (skipSurveyBtn) skipSurveyBtn.addEventListener('click', hideKnowledgeProfileModal);
            if (knowledgeProfileClose) knowledgeProfileClose.addEventListener('click', hideKnowledgeProfileModal);
            
            // Close modals when clicking outside them
            window.addEventListener('click', function(e) {
                if (e.target === loginModal) hideLoginModal();
                if (e.target === registerModal) hideRegisterModal();
                if (e.target === knowledgeProfileModal) hideKnowledgeProfileModal();
            });

            // Initialize user display on page load
            updateUserDisplay();
            
            console.log('All event listeners added successfully');
        } catch (error) {
            console.error('Error setting up event listeners:', error);
        }

        /*
         * Show/hide loading overlay and disable/enable game controls
         * Prevents double submissions during async operations
         */
        function showLoading() {
            isLoading = true;
            loadingOverlay.classList.add('active');
            // Disable all game control buttons
            startGameBtn.disabled = true;
            if (!getHintBtn.disabled) getHintBtn.dataset.wasEnabled = 'true';
            if (!revealAnswerBtn.disabled) revealAnswerBtn.dataset.wasEnabled = 'true';
            if (!submitGuessBtn.disabled) submitGuessBtn.dataset.wasEnabled = 'true';
            getHintBtn.disabled = true;
            revealAnswerBtn.disabled = true;
            submitGuessBtn.disabled = true;
            guessInput.disabled = true;
        }

        function hideLoading() {
            isLoading = false;
            loadingOverlay.classList.remove('active');
            // Re-enable start game button
            startGameBtn.disabled = false;
            // Only re-enable buttons that were enabled before loading
            if (gameActive) {
                if (getHintBtn.dataset.wasEnabled === 'true') getHintBtn.disabled = false;
                if (revealAnswerBtn.dataset.wasEnabled === 'true') revealAnswerBtn.disabled = false;
                if (submitGuessBtn.dataset.wasEnabled === 'true') submitGuessBtn.disabled = false;
                guessInput.disabled = false;
            }
            // Clear the wasEnabled flags
            delete getHintBtn.dataset.wasEnabled;
            delete revealAnswerBtn.dataset.wasEnabled;
            delete submitGuessBtn.dataset.wasEnabled;
        }

        /*
         * Status message display - shows messages inline in the hints header
         * Updates the status text next to "‚óè ‚óè ‚óè HINTS:" 
         */
        function showToast(message, type = 'info') {
            if (!statusMessage) return;
            
            // Update the status message text and style
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            
            // Clear the message after 5 seconds
            clearTimeout(statusMessage.clearTimer);
            statusMessage.clearTimer = setTimeout(() => {
                statusMessage.textContent = '';
                statusMessage.className = 'status-message';
            }, 5000);
        }

        /*
         * Typewriter effect for hints
         * Makes hint text appear character-by-character for a more engaging experience
         */
        function typeWriter(element, text, speed = 30) {
            return new Promise((resolve) => {
                let i = 0;
                element.textContent = '';
                
                function type() {
                    if (i < text.length) {
                        element.textContent += text.charAt(i);
                        i++;
                        setTimeout(type, speed);
                    } else {
                        resolve();
                    }
                }
                
                type();
            });
        }

        /*
         * Helper function to scroll the hints container to the bottom
         * Called after adding a new hint so the user sees the latest hint
         */
        function scrollHintsToBottom() {
            const hintsContainer = document.querySelector('.hints-scroll-container');
            if (hintsContainer) {
                hintsContainer.scrollTop = hintsContainer.scrollHeight;
            }
        }

        /* 
         * Function to start a new game
         * This function sends a request to the Flask server to begin a new game session
         */
        function startNewGame() {
            // Prevent double submissions
            if (isLoading) return;
            
            // Check if a game is already active
            if (gameActive) {
                if (confirm('A game is already in progress. Do you want to start a new game? This will end the current game.')) {
                    // User confirmed - proceed with new game
                } else {
                    // User cancelled - don't start new game
                    return;
                }
            }
            
            // Show loading indicator
            showLoading();
            
            // Use fetch() to make an HTTP request to our Flask server
            fetch('/start_game', {
                method: 'POST',                                  // POST method for sending data
                headers: {
                    'Content-Type': 'application/json',          // Tell server we're sending JSON
                }
            })
            .then(response => response.json())                   // Convert response to JSON
            .then(async data => {                                // Handle the server's response
                hideLoading();
                
                if (data.status === 'success') {
                    // Game started successfully - update the user interface
                    gameActive = true;                           // Set game state to active
                    showToast(data.message, 'success');         // Show success toast
                    
                    // Initialize hints counter from server
                    currentHintsRemaining = data.hints_remaining;
                    
                    // Reset the user interface to clean state
                    hintsList.innerHTML = '';                    // Clear any old hints
                    hintsRemaining.textContent = '';             // Clear hint counter
                    guessInput.value = '';                       // Clear guess input field
                    resultSection.innerHTML = '';                // Clear any old results
                    
                    // Remove any previous animation classes
                    hintsSection.classList.remove('terminal-boot');
                    guessSection.classList.remove('terminal-boot');
                    
                    // Show/hide page sections appropriately
                    hintsSection.style.display = 'block';       // Show hints section
                    guessSection.style.display = 'block';       // Show guess section
                    
                    // Trigger terminal opening animation with a small delay for reflow
                    requestAnimationFrame(() => {
                        hintsSection.classList.add('terminal-boot');
                        guessSection.classList.add('terminal-boot');
                        document.querySelector('.game-controls').classList.add('game-active');
                    });
                    
                    // Update button states
                    startGameBtn.textContent = 'Start New Game'; // Reset button text
                    getHintBtn.disabled = false;                 // Enable hint button
                    revealAnswerBtn.disabled = false;            // Enable reveal button
                    guessInput.disabled = false;                 // Enable guess input
                    submitGuessBtn.disabled = false;             // Enable submit button
                    
                    // Display the first hint automatically if provided with typewriter effect
                    if (data.first_hint) {
                        const li = document.createElement('li');
                        hintsList.appendChild(li);
                        await typeWriter(li, data.first_hint, 25);
                        scrollHintsToBottom();                       // Scroll to show new hint
                        hintsRemaining.textContent = `Hints remaining: ${currentHintsRemaining}`;
                        
                        // Disable hint button if no more hints
                        if (currentHintsRemaining === 0) {
                            getHintBtn.disabled = true;
                        }
                    }
                } else {
                    // Something went wrong - show error toast
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                // Handle network errors or other problems
                console.error('Error:', error);                 // Log error to browser console
                showToast('Error starting game. Please try again.', 'error');
            });
        }

        /* 
         * Function to request a hint from the server
         * This adds a new hint to the hints list and updates the remaining count
         */
        function getHint() {
            // Don't do anything if no game is active, loading, or no hints remaining
            if (!gameActive || isLoading || currentHintsRemaining <= 0) return;

            // Immediately decrement hints counter and update UI to prevent double-click bugs
            currentHintsRemaining--;
            hintsRemaining.textContent = `Hints remaining: ${currentHintsRemaining}`;
            
            // Disable button immediately if no hints left
            if (currentHintsRemaining <= 0) {
                getHintBtn.disabled = true;
            }

            // Show loading indicator
            showLoading();

            // Send request to Flask server for a hint
            fetch('/get_hint', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(async data => {
                hideLoading();
                
                if (data.status === 'success') {
                    // Sync local counter with server value
                    currentHintsRemaining = data.hints_remaining;
                    hintsRemaining.textContent = `Hints remaining: ${currentHintsRemaining}`;
                    
                    // Check if there are no more hints available
                    if (data.hints_remaining === 0 && !data.hint) {
                        getHintBtn.disabled = true;              // Disable the hint button
                        showToast('No more hints available! Make your guess.', 'warning');
                    } else if (data.hint) {
                        // Hint received successfully - add it to the page with typewriter effect
                        
                        // Create a new list item (<li>) element for this hint
                        const li = document.createElement('li');
                        hintsList.appendChild(li);
                        await typeWriter(li, data.hint, 25);         // Typewriter effect
                        scrollHintsToBottom();                       // Scroll to show new hint
                        
                        // Check if this was the last hint
                        if (data.hints_remaining === 0) {
                            getHintBtn.disabled = true;              // Disable the hint button
                            showToast('No more hints available! Make your guess.', 'warning');
                        } else {
                            getHintBtn.disabled = false;             // Re-enable if hints available
                            showToast('Hint added! You can ask for more hints or make a guess.', 'info');
                        }
                    }
                } else {
                    // Error getting hint - restore the counter
                    currentHintsRemaining++;
                    hintsRemaining.textContent = `Hints remaining: ${currentHintsRemaining}`;
                    if (currentHintsRemaining > 0) {
                        getHintBtn.disabled = false;
                    }
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                // Error - restore the counter
                currentHintsRemaining++;
                hintsRemaining.textContent = `Hints remaining: ${currentHintsRemaining}`;
                if (currentHintsRemaining > 0) {
                    getHintBtn.disabled = false;
                }
                console.error('Error:', error);
                showToast('Error getting hint. Please try again.', 'error');
            });
        }

        /* 
         * Function to submit a guess to the server
         * This checks the user's guess against the correct answer
         */
        function makeGuess() {
            // Don't do anything if no game is active or loading
            if (!gameActive || isLoading) return;

            // Get the guess from the input field and remove extra whitespace
            const guess = guessInput.value.trim();
            
            // Check if the user actually entered something
            if (!guess) {
                showToast('Please enter a guess!', 'error');
                return;                                          // Exit the function early
            }

            // Show loading indicator
            showLoading();

            // Send the guess to the Flask server
            fetch('/make_guess', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ guess: guess })           // Send guess as JSON data
            })
            .then(response => response.json())
            .then(async data => {
                hideLoading();
                
                if (data.status === 'success') {
                    // Check if the guess was correct
                    if (data.correct) {
                        // Correct guess - end the game
                        gameActive = false;                      // Set game as inactive
                        showToast(data.message, 'success');     // Show success toast
                        
                        // Disable all game buttons since game is over
                        getHintBtn.disabled = true;
                        revealAnswerBtn.disabled = true;
                        guessInput.disabled = true;
                        submitGuessBtn.disabled = true;
                    } else {
                        // Wrong guess - apply shake animation
                        guessInput.classList.add('shake');
                        setTimeout(() => {
                            guessInput.classList.remove('shake');
                        }, 500); // Match animation duration
                        
                        showToast(data.message, 'warning');
                        guessInput.value = '';                   // Clear the input field
                        guessInput.focus();                      // Put cursor back in input
                        
                        // If a new hint was provided, add it to the list with typewriter effect
                        if (data.new_hint) {
                            const li = document.createElement('li');
                            hintsList.appendChild(li);
                            await typeWriter(li, data.new_hint, 25);
                            scrollHintsToBottom();                   // Scroll to show new hint
                            
                            // Sync local counter with server value
                            currentHintsRemaining = data.hints_remaining;
                            hintsRemaining.textContent = `Hints remaining: ${currentHintsRemaining}`;
                            
                            // Disable hint button if no more hints available
                            if (currentHintsRemaining === 0) {
                                getHintBtn.disabled = true;
                            }
                        }
                    }
                } else {
                    // Server error
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                showToast('Error making guess. Please try again.', 'error');
            });
        }

        /* 
         * Function to give up and reveal the correct answer
         * This ends the current game and shows the answer
         */
        function revealAnswer() {
            // Don't do anything if no game is active or loading
            if (!gameActive || isLoading) return;

            // Ask for confirmation since this will end the game
            if (confirm('Are you sure you want to reveal the answer? This will end the current game.')) {
                // Show loading indicator
                showLoading();
                
                // User confirmed - request the answer from the server
                fetch('/get_answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    
                    if (data.status === 'success') {
                        // Answer revealed - end the game
                        gameActive = false;                      // Set game as inactive
                        showToast(data.message, 'warning');     // Show the answer toast
                        
                        // Disable all game controls since game is over
                        getHintBtn.disabled = true;
                        revealAnswerBtn.disabled = true;
                        guessInput.disabled = true;
                        submitGuessBtn.disabled = true;
                    } else {
                        // Server error
                        showToast(data.message, 'error');
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error:', error);
                    showToast('Error revealing answer. Please try again.', 'error');
                });
            }
            // If user clicked "Cancel" in the confirmation dialog, nothing happens
        }

        /* Authentication Functions */
        
        function updateUserDisplay() {
            /**
             * Update the user status display based on current authentication state
             */
            if (currentUser === 'guest') {
                userDisplay.textContent = 'GUEST';
                loginBtn.style.display = 'inline-block';
                registerBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                statsLink.style.display = 'none';  // Hide stats for guests
            } else {
                userDisplay.textContent = currentUser.toUpperCase();
                loginBtn.style.display = 'none';
                registerBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                statsLink.style.display = 'inline-block';  // Show stats for logged in users
            }
        }

        function showLoginModal() {
            loginModal.style.display = 'block';
            document.getElementById('login-username').focus();
        }

        function hideLoginModal() {
            loginModal.style.display = 'none';
            loginForm.reset();
            // Clear any error messages
            const loginError = document.getElementById('login-error');
            if (loginError) {
                loginError.style.display = 'none';
                loginError.textContent = '';
            }
        }

        function showRegisterModal() {
            registerModal.style.display = 'block';
            document.getElementById('register-username').focus();
        }

        function hideRegisterModal() {
            registerModal.style.display = 'none';
            registerForm.reset();
            // Clear any error messages
            const registerError = document.getElementById('register-error');
            if (registerError) {
                registerError.style.display = 'none';
                registerError.textContent = '';
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const loginError = document.getElementById('login-error');

            // Clear previous error
            if (loginError) {
                loginError.style.display = 'none';
                loginError.textContent = '';
            }

            fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    currentUser = username;
                    hideLoginModal();
                    updateUserDisplay();
                    showToast(data.message, 'success');
                    // Don't show survey on login, only on registration
                } else {
                    // Show error message in the modal
                    if (loginError) {
                        loginError.textContent = data.message;
                        loginError.style.display = 'block';
                    }
                }
            })
            .catch(error => {
                console.error('Login error:', error);
                if (loginError) {
                    loginError.textContent = 'Login failed. Please try again.';
                    loginError.style.display = 'block';
                }
            });
        }

        function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const registerError = document.getElementById('register-error');

            // Clear previous error
            if (registerError) {
                registerError.style.display = 'none';
                registerError.textContent = '';
            }

            fetch('/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    currentUser = username;
                    hideRegisterModal();
                    updateUserDisplay();
                    showToast(data.message, 'success');
                    // Show knowledge profile survey for new users
                    setTimeout(() => {
                        showKnowledgeProfileModal();
                    }, 500);  // Small delay for better UX
                } else {
                    // Show error message in the modal
                    if (registerError) {
                        registerError.textContent = data.message;
                        registerError.style.display = 'block';
                    }
                }
            })
            .catch(error => {
                console.error('Registration error:', error);
                if (registerError) {
                    registerError.textContent = 'Registration failed. Please try again.';
                    registerError.style.display = 'block';
                }
            });
        }

        function playAsGuest() {
            fetch('/play_as_guest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                currentUser = 'guest';
                updateUserDisplay();
                showToast(data.message, 'info');
                // Clear any active game when switching to guest
                gameActive = false;
                resetGameUI();
            })
            .catch(error => {
                console.error('Guest mode error:', error);
                showToast('Failed to switch to guest mode.', 'error');
            });
        }

        function logout() {
            fetch('/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                currentUser = 'guest';
                updateUserDisplay();
                showToast(data.message, 'info');
                // Clear any active game when logging out
                gameActive = false;
                resetGameUI();
            })
            .catch(error => {
                console.error('Logout error:', error);
                showToast('Logout failed.', 'error');
            });
        }

        function resetGameUI() {
            /**
             * Reset the game UI to initial state
             */
            startGameBtn.disabled = false;
            getHintBtn.disabled = true;
            revealAnswerBtn.disabled = true;
            guessInput.disabled = true;
            submitGuessBtn.disabled = true;
            hintsList.innerHTML = '';
            hintsRemaining.textContent = '';
            hintsSection.style.display = 'none';
            guessSection.style.display = 'none';
            resultSection.innerHTML = '';
            // Remove animation classes
            hintsSection.classList.remove('terminal-boot');
            guessSection.classList.remove('terminal-boot');
            const gameControls = document.querySelector('.game-controls');
            if (gameControls) {
                gameControls.classList.remove('game-active');
            }
        }

        /*
         * Function to show project information
         * This displays information about the thesis project and data usage
         */
        function showProjectInfo() {
            const message = `About SpyGame

This is a final degree project (proyecto de fin de grado) that studies human guessing patterns and behavior.

Data Collection:
‚Ä¢ Game sessions (hints requested, guesses made, success/failure) are saved
‚Ä¢ No personal information or user profiling is collected
‚Ä¢ All data will be used later for scientific research

Thank you for your collaboration in this research project! Your participation helps advance our understanding of how people solve puzzles and make guesses.`;

            alert(message);
        }

        /* Knowledge Profile Survey Functions */
        
        function showKnowledgeProfileModal() {
            if (knowledgeProfileModal) {
                knowledgeProfileModal.style.display = 'block';
            }
        }

        function hideKnowledgeProfileModal() {
            if (knowledgeProfileModal) {
                knowledgeProfileModal.style.display = 'none';
                knowledgeProfileForm.reset();
            }
        }

        function checkAndShowKnowledgeProfile() {
            /**
             * Check if the user has already completed the knowledge profile
             * If not, show the survey modal
             */
            fetch('/check_knowledge_profile', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && !data.has_profile && !data.is_guest) {
                    // User is logged in but hasn't completed the survey
                    setTimeout(() => {
                        showKnowledgeProfileModal();
                    }, 500);
                }
            })
            .catch(error => {
                console.error('Error checking knowledge profile:', error);
            });
        }

        function handleKnowledgeProfileSubmit(e) {
            e.preventDefault();
            
            // Collect form data
            const formData = new FormData(knowledgeProfileForm);
            const surveyData = {};
            
            for (let [key, value] of formData.entries()) {
                surveyData[key] = parseInt(value);
            }
            
            // Submit to server
            fetch('/save_knowledge_profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(surveyData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    hideKnowledgeProfileModal();
                    showToast(data.message, 'success');
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error saving knowledge profile:', error);
                showToast('Failed to save knowledge profile. Please try again.', 'error');
            });
        }
    </script>
    <!-- End of JavaScript section -->
</body>
<!-- End of HTML body -->
</html>
<!-- End of HTML document -->
